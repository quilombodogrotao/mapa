<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quilombo do Grotão</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #app { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; }

    /* Responsivo básico */
    @media (max-width: 768px) {
      #app { flex-direction: column; }
      #svgContainer, #category-panel, #dataForm { width: 100%; }
    }

    /* Container SVG */
    #svgContainer { position: relative; /* touch-action removed for native pinch-zoom */ }
    #svgMap {
      border: 1px solid #ccc;
      width: 100%;
      height: 80vh;
      display: block;
    }
    .zoom-btn {
      position: absolute;
      top: 10px;
      background: rgba(255,255,255,0.8);
      border: 1px solid #888;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 4px;
    }
    #zoomIn { right: 90px; }
    #zoomOut { right: 50px; }
    #resetZoom { right: 10px; }

    /* Painel de categorias */
    #category-panel { background: #f9f9f9; padding: 10px; border: 1px solid #ccc; border-radius: 5px; max-width: 200px; }
    #category-panel h2 { margin-top: 0; }
    #category-panel p { font-weight: bold; margin-bottom: 0.5em; }
    #category-panel ul { list-style: none; padding: 0; margin: 0; }
    #category-panel li { margin: 4px 0; }
    #category-panel label { cursor: pointer; }
    .color-swatch { display: inline-block; width: 1em; height: 1em; margin-right: 0.5em; vertical-align: middle; border: 1px solid #000; }
    .cat1 { background: red; }
    .cat2 { background: blue; }
    .cat3 { background: green; }
    .cat4 { background: yellow; }
    .cat5 { background: purple; }
    .cat6 { background: orange; }
    .cat7 { background: cyan; }
    .cat8 { background: magenta; }

    /* Formulário */
    #dataForm { margin-top: 20px; max-width: 800px; }
    #dataForm div { margin-bottom: 10px; }
    #dataForm input, #dataForm textarea { width: 100%; padding: 6px; box-sizing: border-box; }
    #dataForm button { padding: 8px 16px; margin-right: 10px; }
    #clearBtn { background: #f44336; color: #fff; border: none; cursor: pointer; }
    #clearBtn:hover { background: #d32f2f; }

    /* Seleção e contorno */
    .selected {
      stroke: black !important;
      stroke-width: 4px !important;
    }
    #svgMap path, #svgMap polygon, #svgMap rect, #svgMap circle, #svgMap ellipse, #svgMap polyline {
      cursor: pointer;
      pointer-events: visible;
      stroke: white; /* contorno padrão branco */
    }
  </style>
</head>
<body>
  <h1>Quilombo do Grotão</h1>
  <div id="app">
    <div id="svgContainer">
      <button id="zoomIn" class="zoom-btn">＋</button>
      <button id="zoomOut" class="zoom-btn">－</button>
      <button id="resetZoom" class="zoom-btn">⟳</button>
      <svg id="svgMap" viewBox="0 0 4106 2534" xmlns="http://www.w3.org/2000/svg">
        <defs id="map-defs"></defs>
        <image href="grotao - mapinha - vFinal - uso para o site.png" x="0" y="0" width="4106" height="2534" preserveAspectRatio="xMidYMid meet" />
        <g id="areas">
          <path id="Forma_1" d="M1370,103l118,146-119,56-82-164Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_2" d="M1201,177.165L1287,143l80,160-84,39Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_3" d="M738,391l464-213.835L1282,341l-41.85,19L1230,345,866,585Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_4" d="M1464,59.055L1372,103l73,91,48-28,1-9Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_5" d="M1512,242l-19-74-45,28,42,53Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_6" d="M1503,52l22-6,54,78-58,22Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_7" d="M1640,210l-104.57,26.22L1519,147l59-22Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_8" d="M1682,310l-115,34-31.57-107.78L1641,210Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_9" d="M1704,374l-109.52,49L1567,345l115-33Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_10" d="M1678,223l14-26,79.65-56L1880,197,1780,304l-79-52Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_11" d="M1925,146l-45,48-116-58,75-46,50.76,4Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_12" d="M1758,373l21-67,8-5,97,16-18,83Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_13" d="M1911,354.33h53L2007.87,374l9.13,23-57,24-59-3Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_14" d="M2031,423l-63,78-72,6-6.24-48L1902,419l58,4,56-24Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_15" d="M1856,413.385L1866,442l-207,65-23-54,36-39.615L1759,384Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_16" d="M1889.76,462l5.24,46-64.3,4-5.7-10-2-29.56Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_17" d="M1806,477l12,35-19,53-145.46,1L1640,573l-9-47Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_18" d="M1830.7,515L1813,579l142-3,67,8-54-81Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_19" d="M1809,580l21.7,117L1788,724l-52,22-43,10-25-52-28-94,13.54-31Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_20" d="M1901,807l-70.3-109L1811,580l143-3,68,9-2,122.66L2030,745Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_21" d="M1830.7,862L1800,835l-44-15-62-61,42-12,51-20,43.7-26L1898,808Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_22" d="M1511,244L1245,361l101,146,101-53,5-71,88-28.67Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_23" d="M1590,531.5L1541,354.33,1455,385l-6,69-103,56,402,585,151-100-9.24-17L1875,971l-25,8-6-20,10-10-34-30V899l-8-21-26-23s-27-19.5-30-20-30-8.23-30-8.23l-64-59.055L1645,738l-12-48-38.52-81Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_24" d="M1830.7,863l21.3,66,52,34,16,20,219-143,14-261,27-29L1926,150,1789,301l95,13,25,40.33h55L2007.87,372,2033,424l-61,78,53,81-4,125.66L2033,743l-131,67Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_25" d="M1547,32l113,165,102-60,9.65,5L1689,198l-11,22,20,32,80,56-20,63,105,30-8,12.385L1760,383l-89,30.385L1636,455l25,63-29,8-2-30-35.52-73L1706,374l-64-163L1527,46Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_26" d="M1889.76,317L1867,403l-10,10.385L1867,442l-208,66,3,9,144-39,13,34-20,54H1653.54L1638,574l2,34,13.54-29L1811,578l19.7-64-4.7-10-1-31.56L1889.76,462,1901,413.385l10-59.055Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_27" d="M1465,59.055L1503,53l32.43,183.22L1566,345l28.48,80L1629,495l1,36.5,7,39.5,1,38,30,99.66L1692,759l62,60,47,18,29.7,26,22.3,66,50,34,16,19-18,13-11.24-19L1874,970l-24,7-5-17,9-15.12L1821,919l1-18-10-23-25-23-30-19-30-9.23-62-59.055S1652,755,1647,738s-13-46-13-46l-39.52-83L1590,531.5,1541,354.33,1512,244l-17-76V156Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_28" d="M1930,1003.93l13,12.07,16,33,14,2,12,11.99,43,21.01,43-6s21,11,35,8,24-6,24-6l17,5,11,16,27.03,4,25.97,17.05,28,27.95,35-3,23,7,6.14,16,17.86,17,14,44,27.2,35-22.2,52,17,69,17,30.32,18,67.68-47,12-35-203-17-62-22-44-22-6.9h-35l-12-14.1-16.97-24L2163,1133l-12,7-16-1-33-29-76-4-23-2-30-5-24.18-15L1938,1071l-5-27-14-5-12-18-2-10-3-12,20-11Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_29" d="M2141,844L1923,986l15,22,10.82,7,12.18,30,14,4,10,13.99,43,18.01,43-8,25,11,29.98-8,24.02,10,9,12,26.03,6,25.97,18.05,28,25.95,35-3,23,7,6.14,17,23.86,19,10,43,25.2,34-20.2,53,20.2,69,15.8,30.32,16,65.68,198-49L2195,944.88Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_30" d="M1750,1097l148-93.07,5,18.07s7.5,14,13,18,16,8,16,8l3,24,32,28,40.87,7,59.06,4,33.07,2,32,30h20l10-6,23.03,10,25.97,34.1h33.09c4.91,0,25.91,8.9,25.91,8.9l21,42,18,63,35,201-176,39.43,43-118.11L2161,1323l-316-88Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_31" d="M2594,1437l-303,77-31,178,49,88,182,16,171-64,54.53-124,16.47-72.57L2598.42,1503Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_32" d="M2415,1793l28,76-44,79.82-1,35.18,8,23.87-7,13.13-7,7-1,11-13,15-31-1,2,25-13-7h-23l4-31s5-19.87,18-26,27.2-16,27.2-16l-7.2-18-30-15-2-37,14-30,33-13,7-43-14.8-55Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_33" d="M2362.2,2095v38l-41.2,27-39-14-4-42,19-32,39,1Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_34" d="M2331,2367l-9-204,40.2-33v-37l-11.2-15-1-23,29,1,14-16,1-12,15-15-1-10-7-16-2-38.18,47-80.82-30-77,75,6,171-63,54.53-126,19.47-72.57L3349,1678l-11,70-95,91-198,97-328.47,102L2555,2110l-128,101Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
          <path id="Forma_35" d="M2276,2461l-38,19.31L2066.93,2475,1979,2404l-83-119,274-749.57L2287,1515l-28,177,44.14,88s48.66,4.5,53.86,8,17,56,17,56l-6,40-37,13-11,31,3,32,30,22,9.2,17-30.2,15-18,19-2,33.93-16,5.07-19,29,3,47,40,15,11,204Z" fill="none" stroke="#383838" stroke-width="3" fill-rule="evenodd"/>
        </g>
      </svg>
    </div>
    <div id="category-panel">
      <h2>Categorias</h2>
      <p>Área selecionada: <span id="selected-area">Nenhuma</span></p>
      <ul>
        <li><label><input type="checkbox" value="1" disabled> <span class="color-swatch cat1"></span> Externo ao PESET</label></li>
        <li><label><input type="checkbox" value="2" disabled> <span class="color-swatch cat2"></span> Doméstico</label></li>
        <li><label><input type="checkbox" value="3" disabled> <span class="color-swatch cat3"></span> Coletivo</label></li>
        <li><label><input type="checkbox" value="4" disabled> <span class="color-swatch cat4"></span> Público</label></li>
        <li><label><input type="checkbox" value="5" disabled> <span class="color-swatch cat5"></span> Ambiental</label></li>
        <li><label><input type="checkbox" value="6" disabled> <span class="color-swatch cat6"></span> Particular</label></li>
        <li><label><input type="checkbox" value="7" disabled> <span class="color-swatch cat7"></span> Ritual</label></li>
        <li><label><input type="checkbox" value="8" disabled> <span class="color-swatch cat8"></span> Externo ao território</label></li>
      </ul>
    </div>
    <form id="dataForm">
      <div>
        <label for="nameInput">Nome do Usuário:</label><br>
        <input type="text" id="nameInput" name="Name" required />
      </div>
      <!-- Data oculta -->
      <div style="display:none;"><input type="text" id="dateInput" name="Date" /></div>
      <div>
        <label for="obsInput">Observações:</label><br>
        <textarea id="obsInput" name="Observations" rows="3" placeholder="Insira observações..."></textarea>
      </div>
      <button type="submit">Enviar</button>
      <button type="button" id="clearBtn">Limpar Seleções</button>
    </form>
  </div>
  <script>
    // Zoom/Pan config
    const initVB = { x:0, y:0, w:4106, h:2534 };
    let vb = { ...initVB };
    const zoomFactor = 1.2, minFactor = 0.5, maxFactor = 4;
    let isPanning = false, startPoint = {}, startVB = {};
    const svgEl = document.getElementById('svgMap');
    const container = document.getElementById('svgContainer');

    function clampAndSet() {
      vb.w = Math.min(Math.max(vb.w, initVB.w*minFactor), initVB.w*maxFactor);
      vb.h = (vb.w*initVB.h)/initVB.w;
      vb.x = Math.min(Math.max(vb.x,0), initVB.w-vb.w);
      vb.y = Math.min(Math.max(vb.y,0), initVB.h-vb.h);
      svgEl.setAttribute('viewBox', `${vb.x} ${vb.y} ${vb.w} ${vb.h}`);
    }
    document.getElementById('zoomIn').addEventListener('click',()=>{
      const newW = vb.w/zoomFactor, newH = vb.h/zoomFactor;
      vb.x += (vb.w-newW)/2; vb.y += (vb.h-newH)/2; vb.w = newW; vb.h = newH; clampAndSet();
    });
    document.getElementById('zoomOut').addEventListener('click',()=>{
      const newW = vb.w*zoomFactor, newH = vb.h*zoomFactor;
      vb.x -= (newW-vb.w)/2; vb.y -= (newH-vb.h)/2; vb.w = newW; vb.h = newH; clampAndSet();
    });
    document.getElementById('resetZoom').addEventListener('click',()=>{ vb = {...initVB}; clampAndSet(); });

    // Pan with mouse
    svgEl.addEventListener('mousedown', e => {
      isPanning = true;
      startPoint = { x: e.clientX, y: e.clientY };
      startVB = { ...vb };
    });
    window.addEventListener('mousemove', e => {
      if (!isPanning) return;
      const rect = svgEl.getBoundingClientRect();
      vb.x = startVB.x - (e.clientX - startPoint.x) * (startVB.w / rect.width);
      vb.y = startVB.y - (e.clientY - startPoint.y) * (startVB.h / rect.height);
      clampAndSet();
    });
    window.addEventListener('mouseup', () => { isPanning = false; });

    // Native pinch-to-zoom handled by browser

    // Selection, Clear and Export
    const scriptURL = "https://script.google.com/macros/s/AKfycbyLuN2VTNSJTuSIACjgJ0zn5At6AI_7UG2ZFUHsStf3XVfPg2oNQ0JEMAhvpmldUXE6/exec";
    const categoryColors={1:'red',2:'blue',3:'green',4:'yellow',5:'purple',6:'orange',7:'cyan',8:'magenta'};
    let selectedCategories={}, selectedArea=null;
    const defs=document.getElementById('map-defs');
    document.querySelectorAll('#areas path').forEach(el=>{
      selectedCategories[el.id]=[];
      el.dataset.origColor=el.getAttribute('fill')||'none';
      el.setAttribute('fill-opacity','0.4');
      el.setAttribute('stroke','white');
      el.addEventListener('click',()=>selectArea(el));
    });
    document.getElementById('clearBtn').addEventListener('click',()=>{
      document.querySelectorAll('#areas path').forEach(el=>{
        selectedCategories[el.id]=[];
        el.classList.remove('selected');
        el.setAttribute('fill',el.dataset.origColor);
        el.setAttribute('fill-opacity','1');
      });
      selectedArea=null;
      document.getElementById('selected-area').textContent='Nenhuma';
      document.querySelectorAll('#category-panel input').forEach(cb=>{cb.disabled=true;cb.checked=false;});
    });
    document.querySelectorAll('#category-panel input').forEach(cb=>cb.addEventListener('change',()=>{
      if(!selectedArea) return;
      const cats=Array.from(document.querySelectorAll('#category-panel input')).filter(i=>i.checked).map(i=>Number(i.value));
      selectedCategories[selectedArea.id]=cats;
      applyCategoriesToArea(selectedArea,cats);
    }));
    function selectArea(el) {
      if (selectedArea) selectedArea.classList.remove('selected');
      selectedArea = el;
      selectedArea.classList.add('selected');
      document.getElementById('selected-area').textContent = el.id;
      document.querySelectorAll('#category-panel input').forEach(cb => {
        cb.disabled = false;
        cb.checked = selectedCategories[el.id].includes(Number(cb.value));
      });
    }
    function applyCategoriesToArea(el,cats){
      el.setAttribute('fill-opacity','0.4');
      if(!cats.length) return el.setAttribute('fill',el.dataset.origColor);
      if(cats.length===1) return el.setAttribute('fill',categoryColors[cats[0]]);
      const gradId='grad-'+el.id,old=document.getElementById(gradId); if(old)old.remove();
      const grad=document.createElementNS(svgEl.namespaceURI,'linearGradient'); grad.id=gradId;grad.setAttribute('x1','0%');grad.setAttribute('y1','0%');grad.setAttribute('x2','100%');grad.setAttribute('y2','0%');
      cats.forEach((c,i)=>{const color=categoryColors[c];const attrs={'stop-opacity':'0.4','stop-color':color};if(i===0){const s0=document.createElementNS(svgEl.namespaceURI,'stop');Object.entries({offset:'0%',...attrs}).forEach(([k,v])=>s0.setAttribute(k,v));grad.appendChild(s0);}if(i<cats.length-1){const off=((i+1)*100/cats.length).toFixed(2)+'%';const s1=document.createElementNS(svgEl.namespaceURI,'stop');Object.entries({offset:off,...attrs}).forEach(([k,v])=>s1.setAttribute(k,v));grad.appendChild(s1);const s2=document.createElementNS(svgEl.namespaceURI,'stop');Object.entries({offset:off,'stop-opacity':'0.4','stop-color':categoryColors[cats[i+1]]}).forEach(([k,v])=>s2.setAttribute(k,v));grad.appendChild(s2);}else{const sf=document.createElementNS(svgEl.namespaceURI,'stop');Object.entries({offset:'100%',...attrs}).forEach(([k,v])=>sf.setAttribute(k,v));grad.appendChild(sf);}});
      defs.appendChild(grad);
      el.setAttribute('fill',`url(#${gradId})`);
    }
    document.getElementById('dataForm').addEventListener('submit',e=>{e.preventDefault();const name=document.getElementById('nameInput').value.trim();const now=new Date();const ts=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,19);const obs=document.getElementById('obsInput').value.trim();const exportSvg=document.createElementNS(svgEl.namespaceURI,'svg');exportSvg.setAttribute('xmlns','http://www.w3.org/2000/svg');exportSvg.setAttribute('viewBox','0 0 4106 2534');Object.entries(selectedCategories).forEach(([id,cats])=>{if(!cats.length) return;const d=document.getElementById(id).getAttribute('d');cats.forEach(c=>{const p=document.createElementNS(svgEl.namespaceURI,'path');p.setAttribute('d',d);p.setAttribute('fill',categoryColors[c]);p.setAttribute('fill-opacity','0.8');exportSvg.appendChild(p);});});const svgString=new XMLSerializer().serializeToString(exportSvg);const fd=new FormData();fd.append('Name',name);fd.append('Date',ts);fd.append('Observations',obs);fd.append('Selections',svgString);fetch(scriptURL,{method:'POST',mode:'no-cors',body:fd}).then(()=>alert('✅ Dados enviados!')).catch(()=>alert('❌ Erro no envio.'));});
  </script>
</body>
</html>
